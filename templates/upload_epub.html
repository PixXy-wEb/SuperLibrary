<!DOCTYPE html>
<html>
<head>
    <title>Upload PDF for EPUB Conversion</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        h1 { color: #333; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="file"] { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        .btn { 
            padding: 12px 24px; 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px;
        }
        .btn:hover { background-color: #45a049; }
        .btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        .progress { margin-top: 20px; }
        .progress-bar { 
            width: 100%; 
            height: 20px; 
            background-color: #f5f5f5; 
            border-radius: 4px; 
            overflow: hidden;
        }
        .progress-fill { 
            height: 100%; 
            background-color: #4CAF50; 
            width: 0%; 
            transition: width 0.3s;
        }
        .result { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì§ Upload PDF for EPUB Conversion</h1>
        
        <form id="uploadForm">
            <div class="form-group">
                <label for="title">Book Title *</label>
                <input type="text" id="title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="author">Book Author *</label>
                <input type="text" id="author" name="author" required>
            </div>
            
            <div class="form-group">
                <label for="pdfFile">PDF File *</label>
                <input type="file" id="pdfFile" name="pdf_file" accept=".pdf" required>
                <small>Maximum file size: 100MB</small>
            </div>
            
            <button type="submit" class="btn" id="submitBtn">Upload & Convert to EPUB</button>
        </form>
        
        <div class="progress" id="progressSection" style="display: none;">
            <p>Uploading and converting...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">0%</p>
        </div>
        
        <div class="result" id="resultSection" style="display: none;"></div>
        
        <div style="margin-top: 30px;">
            <h3>How it works:</h3>
            <ol>
                <li>Upload a PDF file (up to 100MB)</li>
                <li>Enter the book title and author</li>
                <li>The system will convert the PDF to EPUB format</li>
                <li>Download the EPUB file when conversion is complete</li>
                <li>The book will be added to your library</li>
            </ol>
        </div>
    </div>
    
    <script>
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('title').value;
            const author = document.getElementById('author').value;
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a PDF file');
                return;
            }
            
            if (file.size > 100 * 1024 * 1024) { // 100MB
                alert('File size must be less than 100MB');
                return;
            }
            
            // Show progress
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            
            const formData = new FormData();
            formData.append('title', title);
            formData.append('author', author);
            formData.append('pdf_file', file);
            
            try {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        document.getElementById('progressFill').style.width = percentComplete + '%';
                        document.getElementById('progressText').textContent = Math.round(percentComplete) + '%';
                    }
                });
                
                xhr.addEventListener('load', function() {
                    document.getElementById('progressSection').style.display = 'none';
                    
                    try {
                        const response = JSON.parse(xhr.responseText);
                        const resultDiv = document.getElementById('resultSection');
                        resultDiv.style.display = 'block';
                        
                        if (response.status === 'success') {
                            resultDiv.className = 'result success';
                            resultDiv.innerHTML = `
                                <h3>‚úÖ Conversion Successful!</h3>
                                <p>${response.message}</p>
                                <p>Book: <strong>${response.book.title}</strong> by ${response.book.author}</p>
                                <p>EPUB Size: ${response.epub.size_mb} MB</p>
                                <div style="margin-top: 15px;">
                                    <a href="${response.download_url}" class="btn" style="text-decoration: none;">Download EPUB</a>
                                    <a href="/epub-library" class="btn" style="text-decoration: none; background-color: #2196F3; margin-left: 10px;">View EPUB Library</a>
                                </div>
                            `;
                            
                            // Reset form
                            document.getElementById('uploadForm').reset();
                        } else {
                            resultDiv.className = 'result error';
                            resultDiv.innerHTML = `
                                <h3>‚ùå Conversion Failed</h3>
                                <p>${response.message}</p>
                            `;
                        }
                    } catch (error) {
                        const resultDiv = document.getElementById('resultSection');
                        resultDiv.style.display = 'block';
                        resultDiv.className = 'result error';
                        resultDiv.innerHTML = `
                            <h3>‚ùå Error</h3>
                            <p>Failed to parse server response</p>
                        `;
                    }
                    
                    document.getElementById('submitBtn').disabled = false;
                });
                
                xhr.addEventListener('error', function() {
                    document.getElementById('progressSection').style.display = 'none';
                    
                    const resultDiv = document.getElementById('resultSection');
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h3>‚ùå Upload Failed</h3>
                        <p>Network error. Please try again.</p>
                    `;
                    
                    document.getElementById('submitBtn').disabled = false;
                });
                
                xhr.open('POST', '/api/books/upload-and-convert');
                xhr.send(formData);
                
            } catch (error) {
                document.getElementById('progressSection').style.display = 'none';
                
                const resultDiv = document.getElementById('resultSection');
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h3>‚ùå Error</h3>
                    <p>${error.message}</p>
                `;
                
                document.getElementById('submitBtn').disabled = false;
            }
        });
    </script>
</body>
</html>